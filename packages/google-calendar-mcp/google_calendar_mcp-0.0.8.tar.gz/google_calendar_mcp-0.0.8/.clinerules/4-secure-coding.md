# LLM 向け最適化.clinerules

## 4. セキュリティコーディング規約

### 入力検証と無害化

- すべての外部入力を信頼せず検証する
- 入力値の型、長さ、範囲、形式を厳密に検証する
- バリデーションエラーは一般的なメッセージで応答し、詳細はログに記録する
- SQL/NoSQL インジェクション対策としてパラメータ化クエリを使用する
- XSS 対策として HTML エスケープ処理を実施する
- コマンドインジェクション対策として直接入力をコマンドに渡さない
- 正規表現はシンプルに保ち、タイムアウトを設定する
- `ast.literal_eval()`使用時は例外処理を実装する

### シークレット管理

- シークレットをコードにハードコードしない
- AWS Secrets Manager 等のシークレット管理サービスを使用する
- 環境変数より専用のシークレット管理サービスを優先する
- `.env`ファイルは Git 管理から除外する
- IAM ロールでシークレットアクセスを制限する

### 暗号化とハッシュ

- 保存データと転送データを暗号化する
- 暗号化には`cryptography`ライブラリを使用する
- パスワードハッシュには`bcrypt`を使用し、適切な salt ラウンド数を設定する
- MD5、SHA1 等の安全でないアルゴリズムは使用しない
- JWT トークンには有効期限を設定し、署名を検証する

### ロギングとモニタリング

- ログは構造化形式(JSON 等)で記録する
- センシティブ情報をログに記録しない
- 環境ごとに適切なログレベルを設定する
- エラー発生時は種類、場所、リクエスト ID を記録する
- セキュリティイベントを監視し、異常検知の仕組みを構築する

### 最小権限の原則

- 必要最小限の IAM パーミッションのみを付与する
- リソースベースポリシーを適切に設定する
- 一時的な認証情報を使用し、有効期限を短く設定する
- IAM アクセス権限を定期的に監査する

### サードパーティライブラリ管理

- 依存関係を厳密に管理し、バージョンを固定する
- 脆弱性スキャンを定期的に実行する
- アクティブなコミュニティのあるライブラリを選択する
- 依存関係の変更はコードレビューの対象とする

### エラーハンドリング

- 詳細なエラー情報はログに記録し、ユーザーには一般的なメッセージを表示する
- API エラーコードを定義し、エラー種別を識別可能にする
- エラー発生回数を監視し、異常を検知する
- 未処理の例外をキャッチし、システム停止を防止する

### CORS 設定

- `Access-Control-Allow-Origin`に具体的なドメインを設定する
- プリフライトリクエスト(`OPTIONS`)を適切に処理する
- 必要なヘッダーとメソッドのみを許可する

### セキュリティテスト

- 単体テスト、インテグレーションテスト、ペネトレーションテストを実施する
- 具体的な攻撃シナリオに基づくテストケースを作成する
- CI/CD パイプラインにセキュリティテストを組み込む

### コードレビュー

- セキュリティ観点のチェックリストを作成する
- 静的解析ツールを活用する
- チーム全体でセキュリティ知識を共有する
- 変更箇所だけでなく関連コードもレビュー対象とする

### Serverless 特有の考慮事項

- Lambda 関数のタイムアウト、メモリ、同時実行数を適切に設定する
- API Gateway の認証設定とレート制限を実装する
- EventBridge のイベント送信元と宛先を制限する
- データベースアクセスは IAM ロールで制限する
