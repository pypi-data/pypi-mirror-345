<!DOCTYPE html>
<html>
<head>


<script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='waitme/waitMe.js') }}"></script>
    <script src="{{ url_for('static', filename='xlsx.full.min.js') }}"></script>
<link rel="stylesheet" type="text/css" href="{{url_for('.static', filename='waitme/waitMe.css')}}">
<link rel="stylesheet" type="text/css" href="{{url_for('.static', filename='jquery-ui.css')}}">
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">



<script src="{{ url_for('static', filename='waitme/waitMeFunc.js') }}"></script>

    <title>DPDC:: Meter Reading Testing</title>

</head>
<body id ='body'>
  <div class="navbar">
       <a href="/">Home</a>
      <a href="#">Batch Process </a>
  </div>
<div id='container'>
    <h3>Meter Reading using Deep Learning (Batch Processing)</h3>
    <form id="upload-file" action="/upload_batch" method="post" enctype="multipart/form-data">
    <input type="file"  name="files" id="files" accept="image/*" multiple>
    </form>

    <hr>
        <div class="scrollable-div">
        <table id="imageTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>File Name</th>
                    <th>Classified As</th>
                    <th>Meter Reading</th>
                    <th>Reading Image</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        </div>
    <script>
        document.getElementById('files').addEventListener('change', function(event) {
            const files = event.target.files;

            if (files.length>1000){
                    this.value='';
                    return alert('Please choose less than 1000 files!');
                }
            const tableBody = document.querySelector('#imageTable tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const row = document.createElement('tr');
                    row.id=file.name;
                    const imgCell = document.createElement('td');
                    const nameCell = document.createElement('td');
                    const classCell = document.createElement('td');
                    const readingCell =document.createElement('td');
                    const resImgCell=document.createElement('td');

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imgCell.appendChild(img);

                    nameCell.textContent = file.name;


                    const resimg = document.createElement('img');
                    resimg.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                    resImgCell.appendChild(resimg);


                    row.appendChild(imgCell);
                    row.appendChild(nameCell);
                    row.appendChild(classCell);
                    row.appendChild(readingCell);
                    row.appendChild(resImgCell);
                    tableBody.appendChild(row);
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</div>
<hr>
 <input type="button" class="smart-button" id="upload-file-btn" value="Batch Process"/>
<input type="button" class="smart-button" id="btn-export" onclick="exportTableToExcel()" value="Export Result"/>
</body>
</html>



    <script>
    
	
		$(function(){

			var current_effect = 'ios';

			$('#upload-file-btn').click(function(){
				run_waitMe(current_effect);
			});
		
			
			function run_waitMe(effect){
				$('#body').waitMe({
					effect: effect,
					text: 'Extracting Meter Reading using DPDC ShockWave...',
					bg: 'rgba(255,255,255,0.7)',
					color:'#990033'
				});
			}
			
		});

	
        $('#upload-file-btn').click(function() {
			

            var form_data = new FormData($('#upload-file')[0]);
            form_data.append('imgflg','');
            $.ajax({
                type: 'POST',
                url: '/upload_batch',  // Your Flask endpoint
                data: form_data,
                contentType: false,
                cache: false,
                processData: false,
                success: function(data) {
                    console.log(data);


                     const tableBody = document.querySelector('#imageTable tbody');
                     const rows = tableBody.querySelectorAll('tr');

                    const dtarr=data.message;
                    var i=0;
                    var v_meter=0; var v_imeter=0; var v_calc=0;  var v_err=0; var v_other=0;

                    dtarr.forEach(dtx => {
                            const row = document.getElementById(dtx.filename);
                            const tds = row.querySelectorAll('td');

                            const col3Cell = tds[2];
                            var cls=dtx.cls;
                            if (cls=='Meter')
                                v_meter+=1;
                            else if (cls=='Non-Meter')
                                v_other+=1;
                            else if (cls=='IllegibleMeter')
                                v_imeter+=1;
                             else if (cls=='Calculator')
                                v_calc+=1;
                             else
                                v_err+=1;

                            if (cls=='Meter')
                                col3Cell.innerHTML = '<a href="#" onclick="showImages(this)">Meter</a>';
                            else
                                col3Cell.textContent = cls;

                            row.appendChild(col3Cell);

                            const col4Cell = tds[3];
                            col4Cell.textContent = dtx.reading;
                            row.appendChild(col4Cell);

                           const col5Cell = tds[4];
                                const img = col5Cell.querySelector('img');
                             if (cls=='Meter')
                                img.src = 'data:image/png;base64,'+dtx.img; // Assuming the image path is correct
                              else
                                img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // Assuming the image path is correct

                                col5Cell.appendChild(img);
                                row.appendChild(col5Cell);


                            tableBody.appendChild(row);
                            i++;
                    });

                    console.log('Meter:'+v_meter);
                    console.log('Calculator:'+v_calc);
                    console.log('IllegibleMeter:'+v_imeter);
                    console.log('Others:'+v_other);
                    console.log('Error in Image:'+v_err);

                    const newRow = document.createElement('tr');

                    // Create the first cell
                    const c1 = document.createElement('td');
                    c1.innerHTML = '<label style="font-weight:bold; text-align:right">Total (Summary):</label> '+dtarr.length;

                    // Create the second cell
                    const c2 = document.createElement('td');
                    c2.innerHTML = '<div>Meter: '+v_meter+'</div><div>Calculator: '+v_calc+'</div><div>IllegibleMeter: '+v_imeter+'</div><div>Others: '
                    +v_other+'</div><div>Error in Image: '+v_err+'</div>';

                    // Append the cells to the row
                    newRow.appendChild(c1);
                    newRow.appendChild(c2);

                    // Append the row to the table body
                    tableBody.appendChild(newRow);


					$('#body').waitMe('hide');
                },
				error:function(data){
					var x=JSON.parse( data.responseText)
					alert(JSON.stringify(x));
					$('#body').waitMe('hide');
				}
            });
			$('#body').waitMe('hide');
        });
    
</script>


<script>
    function exportTableToExcel() {
    var table = document.getElementById('imageTable');
    var workbook = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
    XLSX.writeFile(workbook, 'table.xlsx');
}

</script>


 <script>
        function showImages(link) {
            const row = link.closest('tr');
            const images = row.getElementsByTagName('img');
            const popup = window.open("", "ImagePopup", `width=${screen.width},height=${screen.height}`);
            let content ='<div><label style="color:red;font-weight:bold">File Name:</label>'+row.querySelectorAll('td')[1].innerText+'</div>';
               content +='<div><label style="color:red;font-weight:bold">Reding: </label><b>'+row.querySelectorAll('td')[3].innerText+'</b></div><hr>';

             content += '<div style="display: flex; justify-content: space-around; height: 70vh; align-items: center;">';
            for (let img of images) {
                content += `<img src="${img.src}" style="max-width:60%; max-height:100%;">`;
            }

            content += '</div>';
            content += `
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="window.close()">Exit</button>
                </div>
            `;
            popup.document.write(content);
        }
    </script>


 <style>

      .scrollable-div {
            width: 100%;
            height: 360px; /* Set the desired height */
            overflow: auto; /* Enable scrolling */
            border: 1px solid #ccc; /* Optional: Add a border for better visibility */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 5px;
            text-align: center;
        }
         td:nth-child(2), th:nth-child(2) {
            width: 50px; /* Adjust the width as needed */
        }
        img {
            max-width: 210px; /* Set the maximum width */
            height: auto; /* Maintain aspect ratio */
        }
    </style>


<style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            font-size:13px;
        }
        .navbar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #2c3e50;
            padding: 5px 10px;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            transition: background-color 0.3s, color 0.3s;
        }
        .navbar a:hover {
            background-color: #34495e;
            color: #ecf0f1;
            border-radius: 5px;
        }
        .navbar a.active {
            background-color: #e74c3c;
            color: white;
            border-radius: 5px;
        }
    </style>

<style>
        .smart-button {
            background-color: #3498db;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.3s;
        }
        .smart-button:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }
        .smart-button:active {
            background-color: #1c598a;
            transform: scale(0.95);
        }
    </style>