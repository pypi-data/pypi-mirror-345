from PyMELib.PreprocessingAlgorithms import *
from PyMELib.EnumerationAlgorithms import *
from PyMELib.utils.readHypergraphFromFile import read_hypergraph
import os

script_dir = os.path.dirname(os.path.abspath(__file__))

HG1_path = os.path.join(script_dir, "exampleHG.dat")
HG2_path = os.path.join(script_dir, "exampleHG2.dat")
HG3_path = os.path.join(script_dir, "exampleHG3.dat")

example_HG1 = read_hypergraph(HG1_path)
example_MHS1 = {
                frozenset({2, 5, 7}),
                frozenset({2, 4, 5, 6}),
                frozenset({2, 3, 7}),
                frozenset({2, 3, 4, 6}),
                frozenset({1, 5, 7}),
                frozenset({1, 4, 5, 6}),
                frozenset({1, 3, 7}),
                frozenset({1, 3, 4, 6}),
                }

example_HG2 = read_hypergraph(HG2_path)
example_MHS2 = {
        frozenset({2, 4}),
        frozenset({1, 3}),
        frozenset({1, 2}),
        frozenset({1, 4})
    }

example_HG3 = read_hypergraph(HG3_path)
example_MHS3 = {
      frozenset({0, 33, 2, 1, 7, 10, 13, 17, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 13, 17, 19, 20, 21, 22, 23, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 13, 17, 19, 21, 22, 23, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 7, 10, 13, 17, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 7, 10, 13, 17, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 33, 2, 1, 7, 10, 17, 18, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 17, 18, 19, 20, 21, 22, 23, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 17, 18, 19, 21, 22, 23, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 7, 10, 17, 18, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 1, 2, 7, 10, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 10, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31, 32}),
     frozenset({32, 1, 2, 0, 10, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 7, 10, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 7, 10, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 10, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 10, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 7, 10, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 33, 2, 1, 7, 10, 17, 18, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 1, 2, 7, 10, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 7, 10, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 7, 10, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 10, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 10, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 7, 10, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 7, 10, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 33, 2, 1, 5, 10, 13, 17, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 13, 17, 19, 20, 21, 22, 25, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 5, 10, 13, 17, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 13, 17, 19, 20, 21, 22, 24, 25, 28, 31}),
     frozenset({0, 33, 2, 1, 5, 10, 13, 17, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 13, 17, 19, 21, 22, 24, 25, 26, 28, 31}),
     frozenset({0, 33, 2, 1, 5, 10, 17, 18, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 17, 18, 19, 20, 21, 22, 25, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 5, 10, 17, 18, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 17, 18, 19, 20, 21, 22, 24, 25, 28, 31}),
     frozenset({0, 1, 2, 5, 10, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 10, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 5, 10, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 10, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 5, 10, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 10, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 5, 10, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 10, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31}),
     frozenset({0, 33, 2, 1, 5, 10, 17, 18, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 33, 2, 1, 10, 17, 18, 19, 21, 22, 24, 25, 26, 28, 31}),
     frozenset({0, 1, 2, 5, 10, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 10, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 5, 10, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 10, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 5, 10, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 10, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 5, 10, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 10, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 5, 10, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 10, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31}),
     frozenset({0, 33, 2, 7, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 14, 15, 17, 18, 19, 20, 21, 22, 23, 27, 28, 31}),
     frozenset({0, 33, 2, 5, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 14, 15, 17, 18, 19, 20, 21, 22, 25, 27, 28, 31}),
     frozenset({0, 33, 2, 14, 15, 17, 18, 19, 21, 22, 23, 24, 28, 31}),
     frozenset({0, 33, 2, 7, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 33, 2, 5, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 33, 2, 14, 15, 17, 18, 19, 20, 21, 22, 24, 25, 28, 31}),
     frozenset({0, 33, 2, 7, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 33, 2, 5, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 33, 2, 14, 15, 17, 18, 19, 21, 22, 24, 25, 26, 28, 31}),
     frozenset({0, 2, 7, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31, 32}),
     frozenset({0, 2, 14, 15, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31, 32}),
     frozenset({0, 2, 5, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31, 32}),
     frozenset({0, 2, 14, 15, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31, 32}),
     frozenset({32, 0, 2, 14, 15, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 2, 7, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31, 32}),
     frozenset({0, 2, 5, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31, 32}),
     frozenset({0, 2, 14, 15, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31, 32}),
     frozenset({0, 2, 3, 7, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 2, 3, 14, 15, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31}),
     frozenset({0, 2, 3, 5, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 2, 3, 14, 15, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31}),
     frozenset({0, 2, 3, 14, 15, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 2, 3, 7, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 2, 3, 5, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 2, 3, 14, 15, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31}),
     frozenset({0, 2, 7, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31, 32}),
     frozenset({0, 2, 5, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31, 32}),
     frozenset({0, 2, 14, 15, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31, 32}),
     frozenset({0, 2, 3, 7, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 2, 3, 5, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 2, 3, 14, 15, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31}),
     frozenset({0, 2, 4, 7, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 2, 4, 14, 15, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31}),
     frozenset({0, 2, 4, 5, 14, 15, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 2, 4, 14, 15, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31}),
     frozenset({0, 2, 4, 14, 15, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 2, 4, 7, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 2, 4, 5, 14, 15, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 2, 4, 14, 15, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31}),
     frozenset({0, 2, 4, 7, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 2, 4, 5, 14, 15, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 2, 4, 14, 15, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31}),
     frozenset({0, 33, 2, 1, 7, 14, 17, 18, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 14, 17, 18, 19, 20, 21, 22, 23, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 14, 17, 18, 19, 21, 22, 23, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 7, 14, 17, 18, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 7, 14, 17, 18, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 1, 2, 7, 14, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 14, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31, 32}),
     frozenset({32, 1, 2, 0, 14, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 7, 14, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 7, 14, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 14, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 14, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 7, 14, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 7, 14, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 7, 14, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 7, 14, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 14, 17, 18, 19, 20, 21, 22, 23, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 14, 17, 18, 19, 21, 22, 23, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 7, 14, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 7, 14, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 33, 2, 1, 5, 14, 17, 18, 19, 20, 21, 22, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 14, 17, 18, 19, 20, 21, 22, 25, 27, 28, 31}),
     frozenset({0, 33, 2, 1, 5, 14, 17, 18, 19, 20, 21, 22, 24, 28, 31}),
     frozenset({0, 33, 2, 1, 14, 17, 18, 19, 20, 21, 22, 24, 25, 28, 31}),
     frozenset({0, 33, 2, 1, 5, 14, 17, 18, 19, 21, 22, 24, 26, 28, 31}),
     frozenset({0, 33, 2, 1, 14, 17, 18, 19, 21, 22, 24, 25, 26, 28, 31}),
     frozenset({0, 1, 2, 5, 14, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 14, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 5, 14, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 14, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 5, 14, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 14, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 5, 14, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 14, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31}),
     frozenset({0, 1, 2, 5, 14, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 14, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31, 32}),
     frozenset({0, 1, 2, 3, 5, 14, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 3, 14, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 5, 14, 17, 18, 19, 20, 21, 22, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 14, 17, 18, 19, 20, 21, 22, 25, 27, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 5, 14, 17, 18, 19, 20, 21, 22, 24, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 14, 17, 18, 19, 20, 21, 22, 24, 25, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 5, 14, 17, 18, 19, 21, 22, 24, 26, 28, 30, 31}),
     frozenset({0, 1, 2, 4, 14, 17, 18, 19, 21, 22, 24, 25, 26, 28, 30, 31}),
     frozenset({0, 2, 7, 10, 13, 14, 15, 17, 19, 20, 21, 22, 27, 28, 31, 33}),
     frozenset({0, 2, 10, 13, 14, 15, 17, 19, 20, 21, 22, 23, 27, 28, 31, 33}),
     frozenset({0, 2, 5, 10, 13, 14, 15, 17, 19, 20, 21, 22, 27, 28, 31, 33}),
     frozenset({0, 2, 10, 13, 14, 15, 17, 19, 20, 21, 22, 25, 27, 28, 31, 33}),
     frozenset({0, 33, 2, 10, 13, 14, 15, 17, 19, 21, 22, 23, 24, 28, 31}),
     frozenset({0, 2, 7, 10, 13, 14, 15, 17, 19, 20, 21, 22, 24, 28, 31, 33}),
     frozenset({0, 2, 5, 10, 13, 14, 15, 17, 19, 20, 21, 22, 24, 28, 31, 33}),
     frozenset({0, 2, 10, 13, 14, 15, 17, 19, 20, 21, 22, 24, 25, 28, 31, 33}),
     frozenset({0, 2, 7, 10, 13, 14, 15, 17, 19, 21, 22, 24, 26, 28, 31, 33}),
     frozenset({0, 2, 5, 10, 13, 14, 15, 17, 19, 21, 22, 24, 26, 28, 31, 33}),
     frozenset({0, 2, 10, 13, 14, 15, 17, 19, 21, 22, 24, 25, 26, 28, 31, 33}),
}

def test_EnumMDS_recursive():
    td = RootedDisjointBranchNiceTreeDecomposition(example_HG2, debug_flag=False, semi_dntd=False)
    create_factors(td)
    calculate_factors_for_mds_enum(td, td.get_root(), options_for_labels=True)
    assert set(EnumMHS(td, debug_flag=False)) == example_MHS2

def test_EnumMDS_iterative():
    td = RootedDisjointBranchNiceTreeDecomposition(example_HG1, debug_flag=False, semi_dntd=False)
    create_factors(td)
    calculate_factors_for_mds_enum_iterative(td, options_for_labels=True)
    assert set(EnumMHS_iterative(td, debug_flag=False)) == example_MHS1

    td = RootedDisjointBranchNiceTreeDecomposition(example_HG2, debug_flag=False, semi_dntd=False)
    create_factors(td)
    calculate_factors_for_mds_enum_iterative(td, options_for_labels=True)
    assert set(EnumMHS_iterative(td, debug_flag=False)) == example_MHS2


def test_EnumMDS_iterative_semi():
    td = RootedDisjointBranchNiceTreeDecomposition(example_HG1, debug_flag=False, semi_dntd=True)
    create_factors(td)
    calculate_factors_for_mds_enum_iterative(td, options_for_labels=True)
    assert set(EnumMHS_iterative(td, debug_flag=False)) == example_MHS1

    td = RootedDisjointBranchNiceTreeDecomposition(example_HG2, debug_flag=False, semi_dntd=True)
    create_factors(td)
    calculate_factors_for_mds_enum_iterative(td, options_for_labels=True)
    assert set(EnumMHS_iterative(td, debug_flag=False)) == example_MHS2

    td = RootedDisjointBranchNiceTreeDecomposition(example_HG3, debug_flag=False, semi_dntd=True)
    create_factors(td)
    calculate_factors_for_mds_enum_iterative(td, options_for_labels=True)
    assert set(EnumMHS_iterative(td)) == example_MHS3

