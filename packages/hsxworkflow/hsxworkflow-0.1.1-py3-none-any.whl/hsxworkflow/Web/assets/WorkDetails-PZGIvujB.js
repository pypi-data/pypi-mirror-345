import{c as j,M as te,r as p,N as se,O as oe,o as ne,i as ae,P as le,a as re,b as k,h as s,j as l,w as o,K as ie,E as ce,g as W,Q as ue,x as v,m as E,F,e as L,H as de,d as c,D as _e,p as fe,q as m,z as pe,t as $,B as ve,C as ke,k as we,R as me,S as ge,G as ye,n as he,I as We,J as Se}from"./index-DU1D7W6J.js";import{_ as xe,s as r}from"./_plugin-vue_export-helper-CVQjx7MO.js";const Re={class:"work-details-container"},Te={class:"line work-details"},Ce={class:"flex items-center"},Ee={class:"page-header-extra"},Ie={class:"work-details-info"},be={class:"work-details-info-card"},Ne={class:"work-details-info-card"},De={class:"work-details-info-card"},Me={class:"work-details-info-card"},Be={class:"stepContainer"},Fe={key:0,style:{display:"flex"}},Le={key:1,class:"empty-steps"},Ge={class:"log-container-wrapper"},je={class:"log-header"},$e={class:"log-count"},ze={class:"log-list"},He={class:"log-timestamp"},Oe={key:0,class:"empty-log"},z=1e3,Ue={__name:"WorkDetails",setup(Ve){const H=te(),g=j(()=>H.query),O=()=>{window.history.back()};let _=null;const f=p([]),S=p(null),y=p(!1),h=p("standby"),U=p({}),x=p([]),u=se({StartTime:"--",RunNowTime:"--",RunCount:0,RunMode:"--"}),I=p(0),b=p(null),w=p("wait"),V=j(()=>t=>{switch(t){case"running":return"success";case"stopped":return"info";case"error":return"danger";case"standby":return"primary";case"unknown":return"warning";default:return"primary"}}),N=ae("loading"),G=t=>{N.show({text:t===1?"启动中....":"停止中....",timeout:6e4});const e=g.value.id;t===1?r.StartWork(e).then(a=>{D()}):r.StopWork(e).then(a=>{D()})},q=t=>{if(String(t)==="NaN")return"--";const e=Math.floor(t/1e3),n=Math.floor(e/86400),a=Math.floor(e%86400/3600),d=Math.floor(e%3600/60),M=e%60;return[n>0?`${n}d`:"",a>0?`${a}h`:"",d>0?`${d}m`:"",`${M}s`].filter(Boolean).join(" ")},P=t=>{_&&clearInterval(_);const e=new Date(t).getTime(),n=()=>{const a=Date.now();I.value=a-e,u.RunNowTime=a+I.value};n(),_=setInterval(n,1e3)},A=t=>t.includes("ERROR")||t.includes("error")?"log-error":t.includes("WARN")||t.includes("warn")?"log-warn":t.includes("INFO")||t.includes("info")?"log-info":t.includes("DEBUG")||t.includes("debug")?"log-debug":"",D=()=>{r.WorkInfo(g.value.id).then(e=>{const n=e.data;if(n.WorkflowGroup&&n.WorkflowGroup.length>0){const a=n.WorkflowGroup[0];x.value=a.WorkflowStepInfo;let d=a.WorkflowStatus;h.value=d,U.value=a,a.WorkflowStartTime&&(u.StartTime=a.WorkflowStartTime,P(u.StartTime)),u.RunCount=a.WorkflowRunCount,u.RunMode=a.WorkflowRunType,b.value=a.WorkflowCurrentStepIndex,d==="running"?y.value=!0:d!=="running"&&(y.value=!1,_&&clearInterval(_)),N.close()}})};return oe(t=>{f.value.push(t),f.value.length>z&&f.value.shift()},100),ne(()=>{N.show({timeout:6e4}),r.init();let t=setInterval(()=>{r.isConnected===!0&&(g.value.id?r.joinRoom(g.value.id).then(n=>{D()}):console.log("页面初始化失败"),clearInterval(t))},1e3);r.socket.on("work_flow_step_info",e=>{switch(b.value=e.step_index||0,e.status){case 1:w.value="success";break;case"running":w.value="process";break;case 99:w.value="wait";break;case 44:w.value="error";break;case 2:w.value="error";break;case 66:w.value="wait";break}}),r.socket.on("work_flow_step_log",e=>{f.value.push(e.WorkflowLog),f.value.length>z&&f.value.shift();const{scrollTop:n,scrollHeight:a,clientHeight:d}=S.value;n>a-d-100&&le(()=>{S.value&&(S.value.scrollTop=a)})}),r.socket.on("work_flow_list",e=>{let n=e.WorkflowStatus;h.value=n,n==="running"?y.value=!0:n!=="running"&&(y.value=!1,_&&clearInterval(_))}),r.socket.on("work_flow_count",e=>{u.RunCount=e.WorkflowRunCount})}),re(()=>{if(r.socket.off("work_flow_step_log"),r.socket.off("work_flow_step_info"),r.socket.off("work_flow_list"),r.socket.off("work_flow_count"),r.leaveRoom(g.value.id),r.isConnected===!0){console.log("组件卸载"),r.disconnect();let t=setInterval(()=>{r.isConnected===!1&&clearInterval(t)},1e3)}_&&clearInterval(_)}),(t,e)=>{const n=fe,a=pe,d=_e,M=ie,R=me,T=we,K=ce,J=We,B=ye,Q=he,X=ge,Y=de,Z=ue;return c(),k("div",Re,[s("div",Te,[l(M,{onBack:O},{content:o(()=>[s("div",Ce,[l(n,{class:"work-details-headers-title"},{default:o(()=>[m(v(g.value.work),1)]),_:1})])]),extra:o(()=>[s("div",Ee,[l(d,{wrap:""},{default:o(()=>[l(n,{class:"status-text",type:V.value(h.value),size:"large"},{default:o(()=>[m(v(h.value?h.value.toUpperCase():"UNKNOWN"),1)]),_:1},8,["type"]),y.value?(c(),W(a,{key:1,type:"danger",size:"small",icon:$(ke),onClick:e[1]||(e[1]=i=>G(2))},{default:o(()=>e[3]||(e[3]=[m("停止")])),_:1},8,["icon"])):(c(),W(a,{key:0,type:"success",size:"small",icon:$(ve),onClick:e[0]||(e[0]=i=>G(1))},{default:o(()=>e[2]||(e[2]=[m("启动")])),_:1},8,["icon"]))]),_:1})])]),_:1}),s("div",Ie,[l(K,null,{default:o(()=>[l(T,{span:6},{default:o(()=>[s("div",be,[l(R,{value:u.RunMode?u.RunMode.toUpperCase():"--",class:"animated-statistic"},{title:o(()=>e[4]||(e[4]=[s("span",{class:"statistic-title"},"执行模式",-1)])),_:1},8,["value"])])]),_:1}),l(T,{span:6},{default:o(()=>[s("div",Ne,[l(R,{value:u.RunCount,class:"animated-statistic"},{title:o(()=>e[5]||(e[5]=[s("span",{class:"statistic-title"},"执行次数",-1)])),_:1},8,["value"])])]),_:1}),l(T,{span:6},{default:o(()=>[s("div",De,[l(R,{value:u.StartTime,class:"animated-statistic"},{title:o(()=>e[6]||(e[6]=[s("span",{class:"statistic-title"},"启动时间",-1)])),_:1},8,["value"])])]),_:1}),l(T,{span:6},{default:o(()=>[s("div",Me,[l(R,{class:"animated-statistic",value:I.value,formatter:q},{title:o(()=>e[7]||(e[7]=[s("span",{class:"statistic-title"},"运行时间",-1)])),_:1},8,["value"])])]),_:1})]),_:1})]),s("div",Be,[x.value.length>0?(c(),W(Y,{key:0,"align-center":"","process-status":w.value,active:b.value},{default:o(()=>[x.value?(c(!0),k(F,{key:0},L(x.value,i=>(c(),W(X,{placement:"top",trigger:"click",width:400,"show-arrow":!0},{reference:o(()=>[l(J,{title:i.title,description:i.desc||"",style:{"min-width":"200px"}},null,8,["title","description"])]),default:o(()=>[i.retry!==0?(c(),k("div",Fe,[l(B,{style:{margin:"0 5px 5px 0"}},{default:o(()=>[m(" 重试"+v(i.retry)+"次",1)]),_:2},1024),l(B,null,{default:o(()=>[m("重试间隔"+v(i.retry_interval)+"秒",1)]),_:2},1024)])):E("",!0),i.args&&i.args.length>0?(c(!0),k(F,{key:1},L(i.args,(C,ee)=>(c(),W(Q,{key:ee,placement:"top",content:"对应状态调用的对应方法"},{default:o(()=>[l(B,{type:"success",style:{margin:"0 5px 5px 0"}},{default:o(()=>[m(v(C.key_)+" : "+v(C.value_),1)]),_:2},1024)]),_:2},1024))),128)):E("",!0)]),_:2},1024))),256)):E("",!0)]),_:1},8,["process-status","active"])):(c(),k("div",Le,[l(Z,{description:"暂无步骤数据"})]))])]),s("div",Ge,[s("div",je,[e[8]||(e[8]=s("h3",null,"工作流执行日志",-1)),s("span",$e,"日志行数: "+v(f.value.length),1)]),s("div",{class:"log-container",ref_key:"container",ref:S},[s("ul",ze,[(c(!0),k(F,null,L(f.value,(i,C)=>(c(),k("li",{key:C,class:"log-entry"},[s("span",He,"["+v(new Date().toLocaleTimeString())+"]",1),s("span",{class:Se(["log-content",A(i)])},v(i),3)]))),128))]),f.value.length===0?(c(),k("div",Oe,e[9]||(e[9]=[s("i",{class:"icon-empty"},null,-1),s("p",null,"暂无日志数据",-1)]))):E("",!0)],512)])])}}},Ae=xe(Ue,[["__scopeId","data-v-574c7ce6"]]);export{Ae as default};
