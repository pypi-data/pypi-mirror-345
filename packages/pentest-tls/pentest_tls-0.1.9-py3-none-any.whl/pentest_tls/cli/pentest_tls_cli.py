#!/usr/bin/env python3

import argparse
import sys
import pyfiglet

from pentest_tls import util
from . import port_scanner_cli

"""
Pentest Tools - Lightweight Pentest Toolkit

Note:
  - Only IPv4 addresses are supported.
  - Tool types must be valid and recognized by the toolkit.
  - Port scanner just for scanning ports (not including host scanning)
"""

def main():
    """
    Process all arguments, invoke specific module to achieve different functionality
    """
    banner = pyfiglet.figlet_format("Pentest Tools")
    print(banner)

    parser = argparse.ArgumentParser(description="Lightweight Pentest Toolkit")
    parser.add_argument("ip", help="Target IP address")
    parser.add_argument("-t", "--type", help="Tools refer to use. E.g. PS(for port scanner)")
    parser.add_argument("-p", "--ports", help="Port(s) to scan. E.g. 22,80 or 1-1000")
    parser.add_argument("-PU", action="store_true", help="Use UDP ping for port scan")
    parser.add_argument("-PS", action="store_true", help="Use TCP SYN packet for port scan. This is the default option")
    args = parser.parse_args()

    if not util.is_valid_ipv4(args.ip):
        print("FormatError: Invalid IPv4 address.")
        sys.exit(1)
    elif not util.is_valid_type(args.type):
        print("FormatError: Invalid type category.")
        sys.exit(1)

    try:
        if args.ports:
            ports = util.parse_ports(args.ports)
        else:
            if args.PU:
                ports = util.load_default_ports(flag="UDP")
            else:
                ports = util.load_default_ports()
    except ValueError as e:
        print(f"FormatError: {e}")
        sys.exit(1)

    # Port Scanner Logic
    if args.type == "PS":
        port_scanner_cli.process(ports, args.ip, args.PU, args.PS)

if __name__ == "__main__":
    main()
