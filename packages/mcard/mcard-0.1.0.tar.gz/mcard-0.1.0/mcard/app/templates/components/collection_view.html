{% from 'components/card_entry.html' import card_entry %}

<div class="h-full flex flex-col bg-white">
    <div class="p-4 border-b">
        <div class="flex items-center space-x-2">
            <input 
                type="text" 
                id="searchInput"
                placeholder="Search cards..." 
                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </div>
    <div class="flex-1 overflow-y-auto p-4">
        <div id="cardsContainer" class="divide-y divide-gray-200 border rounded-lg">
            {# Initial server-side rendered cards #}
            {% for card in initial_cards %}
                {{ card_entry(card) }}
            {% endfor %}
        </div>
        
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="hidden">
            <div class="flex justify-center items-center p-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </div>

        <!-- Pagination controls -->
        <div class="flex justify-between items-center mt-4 p-4 border-t">
            <button id="prevPage" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            <span id="pageInfo" class="text-gray-600 text-sm"></span>
            <button id="nextPage" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
const pageSize = 12;
let searchTimeout;

function debounce(func, wait) {
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(searchTimeout);
            func(...args);
        };
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(later, wait);
    };
}

function showLoading() {
    document.getElementById('loadingIndicator').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingIndicator').classList.add('hidden');
}

async function fetchCards(query = '', page = 1) {
    showLoading();
    try {
        const response = await fetch(`/cards?query=${encodeURIComponent(query)}&page=${page}&page_size=${pageSize}`);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error fetching cards:', error);
        return { items: [], total_items: 0 };
    } finally {
        hideLoading();
    }
}

function renderCards(cards) {
    console.log('Rendering cards:', cards);
    const container = document.getElementById('cardsContainer');
    if (!Array.isArray(cards)) {
        console.error('Expected cards to be an array');
        return;
    }
    
    container.innerHTML = cards.map(card => renderCardEntry(card)).join('');
}

function updatePaginationControls(totalItems) {
    const totalPages = Math.ceil(totalItems / pageSize);
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    prevButton.disabled = currentPage <= 1;
    nextButton.disabled = currentPage >= totalPages;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
}

async function updateResults() {
    const query = document.getElementById('searchInput').value.trim() === '' ? undefined : document.getElementById('searchInput').value;
    const data = await fetchCards(query, currentPage);
    renderCards(data.items);
    updatePaginationControls(data.total_items);
}

const debouncedSearch = debounce(() => {
    currentPage = 1;
    updateResults();
}, 300);

// Event Listeners
document.getElementById('searchInput').addEventListener('input', debouncedSearch);

document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        updateResults();
    }
});

document.getElementById('nextPage').addEventListener('click', () => {
    currentPage++;
    updateResults();
});

// Initial load
updateResults();
</script>
