"use strict";(self.webpackChunk_fails_components_jupyter_interceptor=self.webpackChunk_fails_components_jupyter_interceptor||[]).push([[526],{198:(e,t,s)=>{s.r(t),s.d(t,{IFailsLauncherInfo:()=>p,default:()=>m});var r=s(611),n=s(898),a=s(144),o=s(335),i=s(675),l=s(970),c=s(262),d=s(602);const p=new c.Token("@fails-components/jupyter-fails:IFailsLauncherInfo","A service to communicate with FAILS.");let u=!1;const h=()=>{if(u)return;const e=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=function(t,s){if("webgl"===t||"webgl2"===t){const r={...s};return r.preserveDrawingBuffer=!0,e.apply(this,[t,r])}return e.apply(this,[t,s])},u=!0};let g=!1;class f{constructor(e){var t,s;this._inLectureChanged=new d.Signal(this),this._selectedAppidChanged=new d.Signal(this),this._remoteUpdateMessageArrived=new d.Signal(this),this._appletSizes={},this._appletSizesChanged=new d.Signal(this),this._appletSizesProxy=new Proxy(this._appletSizes,{get:(e,t)=>{if("symbol"!=typeof t)return e[t]},set:(e,t,s)=>"symbol"!=typeof t&&(e[t]!==s&&(e[t]=s,this._appletSizesChanged.emit(e)),!0)}),this._inLecture=null!==(t=null==e?void 0:e.inLecture)&&void 0!==t&&t,this._selectedAppid=null!==(s=null==e?void 0:e.selectedAppid)&&void 0!==s?s:void 0}get inLectureChanged(){return this._inLectureChanged}get inLecture(){return this._inLecture}set inLecture(e){e!==this._inLecture&&(this._inLecture=e,!1===e&&this._selectedAppid&&(this._selectedAppid=void 0,this._selectedAppidChanged.emit(void 0)),this._inLectureChanged.emit(e))}get selectedAppid(){return this._selectedAppid}get selectedAppidChanged(){return this._selectedAppidChanged}set selectedAppid(e){e!==this._selectedAppid&&(this._selectedAppid=e,this._inLecture||void 0===e?this._inLecture&&void 0===e&&(this._inLecture=!1,this._inLectureChanged.emit(!1)):(this._inLecture=!0,this._inLectureChanged.emit(!0)),this._selectedAppidChanged.emit(e))}get appletSizes(){return this._appletSizesProxy}get appletSizesChanged(){return this._appletSizesChanged}get updateMessageArrived(){return this._updateMessageArrived}set updateMessageArrived(e){this._updateMessageArrived=e}get remoteUpdateMessageArrived(){return this._remoteUpdateMessageArrived}receiveRemoteUpdateMessage(e){this._remoteUpdateMessageArrived.emit(e)}}const m=[{id:"@fails-components/jupyter-fails:launcher",description:"Configures the notebooks application over messages",autoStart:!0,activate:function(e,t,s,r){const{serviceManager:n,started:i}=e;Promise.all([i,n.ready]).then((async()=>{}));const{docRegistry:c}=e,d=new f;let p;const u=e.serviceManager.serverSettings,m=o.URLExt.join(o.PageConfig.getBaseUrl(),o.PageConfig.getOption("licensesUrl"))+"/";let y;window.failsCallbacks||(window.failsCallbacks={});const v=window.failsCallbacks;v.postMessageToFails=(e,t)=>{void 0!==y&&window.parent.postMessage(e,y,t)},s.dirtySignal.connect(((e,t)=>{v.postMessageToFails({task:"docDirty",dirty:t})})),d.reportMetadata=e=>{v.postMessageToFails({task:"reportMetadata",metadata:e})},d.inLectureChanged.connect(((e,t)=>{null!==r&&r.menu.setHidden(t)})),d.appletSizesChanged.connect(((e,t)=>{v.postMessageToFails({task:"reportFailsAppletSizes",appletSizes:t})}));let b=!1;const k=(e,t)=>{v.postMessageToFails({task:"sendInterceptorUpdate",...t})};return window.addEventListener("message",(e=>{var s;switch(void 0===y&&(y=e.origin),e.data.type){case"loadJupyter":{const r=e.data;d.inLecture=null!==(s=r.inLecture)&&void 0!==s?s:d.inLecture,t.autosave=!1,r.installScreenShotPatches&&h(),r.installGDPRProxy&&(({allowedSites:e,proxySites:t,proxyURL:s})=>{if(g)return;const r=[location.origin,...e||[]],n=r.map((e=>"'"+new URL(e).origin+"'")).join(","),a=(t||[]).map((e=>"'"+new URL(e).origin+"'")).join(","),o=globalThis.fetch;globalThis.fetch=async(e,n={})=>{const a=e instanceof URL?e:new URL(e instanceof Request?e.url:e,location.href);if(r.includes(a.origin))return o(e instanceof Request?e:a,n);if(t&&t.includes(a.origin)){const t=s+a.hostname+a.pathname;if(e instanceof Request){const s=e,r=new Request(t,{method:s.method,headers:s.headers,body:s.body,credentials:s.credentials,mode:s.mode,integrity:s.integrity,keepalive:s.keepalive,referrerPolicy:s.referrerPolicy,cache:s.cache,redirect:s.redirect,referrer:s.referrer,signal:s.signal});return o(r,n)}return a.href=t,o(a,n)}return console.log("alien fetch URL:",a.href),new Response("Blocked domain, access forbidden",{status:403,statusText:"Forbidden",headers:{"Content-Type":"text/plain"}})};const i=globalThis.importScripts;globalThis.importScripts=(...e)=>{const n=e.map((e=>{const n=new URL(e,location.href);if(r.includes(n.origin))return e;if(t&&t.includes(n.origin))return s+n.hostname+n.pathname;throw new Error("Script is from blocked URL")}));return i(...n)};const l=Worker,c=function(e,t){const o=e instanceof URL?e:new URL(e,location.href);if(!r.includes(o.origin))return void console.log("Creating worker from blocked origin:",o.origin);console.log("Tap into creating worker:",o.href);const i=`(function() {\n      const allowedOrigins = [ ${n} ];\n      const proxySites = [ ${a} ];\n      const proxyURL = '${s}';\n      const oldFetch = globalThis.fetch;\n      globalThis.fetch = async function(url, options = {}) {\n        const urlObj = url instanceof URL ? url : new URL(url instanceof Request ? url.url : url, location.href);\n        if (allowedOrigins.includes(urlObj.origin)) {\n          return oldFetch(url instanceof Request ? url : urlObj, options);\n        }\n        if (proxySites && proxySites.includes(urlObj.origin)) {\n           // rewrite the URL and response\n          const resURL = proxyURL + urlObj.hostname + urlObj.pathname;\n          console.log('proxy url debug', resURL, urlObj.href);\n          if (url instanceof Request) {\n            const request = url;\n            const newRequest = new Request(resURL, {\n              method: request.method,\n              headers: request.headers,\n              body: request.body,\n              credentials: request.credentials,\n              mode: request.mode,\n              integrity: request.integrity,\n              keepalive: request.keepalive,\n              referrerPolicy: request.referrerPolicy,\n              cache: request.cache,\n              redirect: request.redirect,\n              referrer: request.referrer,\n              signal: request.signal\n          });\n          console.log('proxy request debug', newRequest, request);\n          return oldFetch(newRequest, options);\n        } else {\n          urlObj.href = resURL;\n          return oldFetch(urlObj, options);\n        }\n      }\n      console.log('alien fetch URL worker:', urlObj.href);\n      return new Response('Blocked domain, access forbidden',{\n        status: 403,\n        statusText: 'Forbidden',\n        headers: { 'Content-Type': 'text/plain' }\n      });\n      };\n      const oldImportScripts = globalThis.importScripts;\n      globalThis.importScripts = (...args) => {\n      const newargs = args.map(url => {\n        const urlObj = new URL(url, location.href);\n        if (allowedOrigins.includes(urlObj.origin)) {\n          return url;\n        }\n        if (proxySites && proxySites.includes(urlObj.origin)) {\n          return proxyURL + urlObj.hostname + urlObj.pathname;\n        }\n          throw new Error('Script is from blocked URL');\n        });\n        return oldImportScripts(...newargs);\n      };\n      Object.defineProperty(globalThis, 'location', {\n        value: new URL('${o.href}'),\n        writable: false,\n        configurable: false,\n        enumerable: true,\n      });\n      })();`+("module"===(null==t?void 0:t.type)?`\n      import('${o.href}').catch(error => {\n        console.error('Can not load module patching Worker:', error);\n      });`:`\n      importScripts('${o.href}')\n      `),c=new Blob([i],{type:"application/javascript"}),d=URL.createObjectURL(c),p=new l(d,t);return p.addEventListener("message",(()=>{URL.revokeObjectURL(d)}),{once:!0}),p};(c.prototype=l.prototype).constructor=c,globalThis.Worker=c,g=!0})(r.installGDPRProxy),v.callContents({task:"loadFile",fileData:r.fileData,fileName:r.fileName}).then((()=>{const e={name:r.kernelName||"python"},s=c.defaultWidgetFactory(r.fileName).name;p=t.open(r.fileName,s,e,{ref:"_noref"}),r.appid&&(d.selectedAppid=r.appid);let n=r.rerunAtStartup;if(void 0!==p){const e=p;e.sessionContext.statusChanged.connect(((t,s)=>{if(v.postMessageToFails({task:"reportKernelStatus",status:s}),"idle"===s&&n){console.log("Run all cells after startup");const{context:t,content:s}=e,r=s.widgets;l.NotebookActions.runCells(s,r,t.sessionContext).then((()=>{console.log("Run all cells after startup finished")})).catch((e=>{console.log("Run all cells after startup error",e)})),n=!1}}))}})).catch((e=>{console.log("Problem task load file",e)}))}break;case"saveJupyter":{const s=e.data;if(void 0===p){v.postMessageToFails({requestId:e.data.requestId,task:"saveJupyter",error:"No document loaded"});break}const r=t.contextForWidget(p);if(void 0===r){v.postMessageToFails({requestId:e.data.requestId,task:"saveJupyter",error:"No document context"});break}r.save().then((()=>v.callContents({task:"savedFile",fileName:s.fileName}))).then((({fileData:t})=>{v.postMessageToFails({requestId:e.data.requestId,task:"saveJupyter",fileData:t})})).catch((t=>{v.postMessageToFails({requestId:e.data.requestId,task:"saveJupyter",error:t.toString()})}))}break;case"activateApp":{const t=e.data;t.inLecture?d.selectedAppid=t.appid:d.inLecture=!1,v.postMessageToFails({requestId:e.data.requestId,task:"activateApp"})}break;case"screenshotApp":{const t=e.data,s=p;"function"!=typeof s.takeAppScreenshot&&v.postMessageToFails({requestId:e.data.requestId,task:"screenshotApp",error:"Take App Screenshot unsupported"}),s.takeAppScreenshot({dpi:t.dpi}).then((async t=>{var s,r;if(t){const r=await t.arrayBuffer();null===(s=v.postMessageToFails)||void 0===s||s.call(v,{requestId:e.data.requestId,task:"screenshotApp",screenshot:{data:r,type:t.type}},[r])}else null===(r=v.postMessageToFails)||void 0===r||r.call(v,{requestId:e.data.requestId,task:"screenshotApp",error:"Screenshot failed?"})})).catch((t=>{console.log("Screenshot error",t),v.postMessageToFails({requestId:e.data.requestId,task:"screenshotApp",error:t.toString()})}))}break;case"activateInterceptor":{const t=e.data;b!==t.activate&&d.updateMessageArrived&&(b?(d.updateMessageArrived.disconnect(k),b=!1):(d.updateMessageArrived.connect(k),b=!0)),v.postMessageToFails({requestId:e.data.requestId,task:"activateInterceptor"})}break;case"receiveInterceptorUpdate":{const t=e.data,{path:s,mime:r,state:n}=t;d.receiveRemoteUpdateMessage({path:s,mime:r,state:n}),v.postMessageToFails({requestId:e.data.requestId,task:"receiveInterceptorUpdate"})}break;case"restartKernelAndRerunCells":{if(void 0===p){v.postMessageToFails({requestId:e.data.requestId,task:"restartKernelAndRerunCell",error:"No document loaded"});break}const t=p,{context:s,content:r}=t,n=r.widgets;console.log("rerun kernel hook"),t.sessionContext.restartKernel().then((async()=>{await l.NotebookActions.runCells(r,n,s.sessionContext),v.postMessageToFails({requestId:e.data.requestId,task:"restartKernelAndRerunCell",success:!0})})).catch((t=>{v.postMessageToFails({requestId:e.data.requestId,task:"restartKernelAndRerunCell",error:t.toString()})}))}break;case"getLicenses":a.ServerConnection.makeRequest(m,{},u).then((async t=>{const s=await t.json();v.postMessageToFails({requestId:e.data.requestId,task:"getLicenses",licenses:s})})).catch((t=>{v.postMessageToFails({requestId:e.data.requestId,task:"getLicenses",error:t.toString()})}))}})),e.started.then((async()=>{window.parent&&window.parent.postMessage({task:"appLoaded"},"*"),r&&(r.collapseTop(),d.inLecture)&&r._menuWrapper.hide()})),d},provides:p,requires:[n.IDocumentManager,r.ILabStatus],optional:[i.BK]}]}}]);