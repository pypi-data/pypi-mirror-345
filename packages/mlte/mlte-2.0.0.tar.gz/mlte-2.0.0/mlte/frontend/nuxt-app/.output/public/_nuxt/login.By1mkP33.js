import{n as C,u as a,r as f,q as y,A as V,w as n,B as U,o as B,d,a as _,b as v,y as p,C as x,E as T,G as A,z as I}from"./entry.DZxwSL9U.js";import{r as q}from"./util.B0gNYUhE.js";import{i as N}from"./form-methods.CkGHM49X.js";import{r as E,h}from"./http-error-handling.BbcmLHJS.js";const P={style:{"max-width":"30rem"}},L={class:"margin-button centered-container"},H=C({__name:"login",setup($){const w=I();a("token"),a("user"),a("userRole");const s=f(""),m=f(""),u=f({username:!1,password:!1});async function k(){u.value=q(u.value);let c=!1;if(s.value.trim()===""&&(u.value.username=!0,c=!0),m.value.trim()===""&&(u.value.password=!0,c=!0),c){N();return}const o={grant_type:"password",username:s.value,password:m.value};let r=[];for(const t in o){const e=encodeURIComponent(t),i=encodeURIComponent(o[t]);r.push(e+"="+i)}r=r.join("&");let l=0;try{await $fetch(w.public.apiPath+"/token",{retry:0,method:"POST",headers:{accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},body:r,onRequestError(){E()},onResponse({response:e}){var i,g;if(e.ok){l=(i=e==null?void 0:e._data)==null?void 0:i.expires_in;const R=a("token",{maxAge:l}),b=a("user",{maxAge:l});R.value=(g=e==null?void 0:e._data)==null?void 0:g.access_token,b.value=s.value}},onResponseError({response:e}){h(e.status,e._data.error_description)}});const t=a("token");await $fetch(w.public.apiPath+"/user/me",{retry:0,method:"GET",headers:{Authorization:"Bearer "+t.value},onRequestError(){E()},onResponse({response:e}){if(e.ok){const i=a("userRole",{maxAge:l});i.value=e._data.role}},onResponseError({response:e}){h(e.status,e._data.error_description)}}),A("/")}catch(t){console.log("Error in login: "),console.log(t)}}return(c,o)=>{const r=y("UsaTextInput"),l=y("UsaButton"),t=U;return B(),V(t,{name:"base-layout"},{"page-title":n(()=>[d("Login")]),default:n(()=>[_("form",null,[_("div",P,[v(r,{modelValue:p(s),"onUpdate:modelValue":o[0]||(o[0]=e=>x(s)?s.value=e:null),error:p(u).username},{label:n(()=>[d(" Username ")]),"error-message":n(()=>[d(" Enter a username ")]),_:1},8,["modelValue","error"]),v(r,{modelValue:p(m),"onUpdate:modelValue":o[1]||(o[1]=e=>x(m)?m.value=e:null),error:p(u).password,type:"password"},{label:n(()=>[d(" Password ")]),"error-message":n(()=>[d(" Enter a password ")]),_:1},8,["modelValue","error"]),_("div",L,[v(l,{type:"submit",class:"primary-button",onClick:o[2]||(o[2]=T(e=>k(),["prevent"]))},{default:n(()=>[d(" Login ")]),_:1})])])])]),_:1})}}});export{H as default};
